<section class="companies-page" id="companies">
  <section class="city-nav" aria-label="城市导航">
    <!--COMPANY_NAV-->
  </section>

  <!--COMPANY_SECTIONS-->
</section>
<script>
  (() => {
    const page = document.querySelector('.companies-page');
    if (!page) return;

    const citySections = Array.from(page.querySelectorAll('.city-section'));
    const cityNav = page.querySelector('.city-nav');

    const setCityVisible = (city) => {
      citySections.forEach((section) => {
        const match = city === 'all' || section.dataset.city === city;
        section.hidden = !match;
      });
    };

    const scrollToTarget = (targetId) => {
      const target = targetId ? document.getElementById(targetId) : null;
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };

    if (cityNav) {
      const navButtons = Array.from(cityNav.querySelectorAll('[data-city]'));
      navButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const city = button.dataset.city || 'all';
          navButtons.forEach((btn) => btn.classList.toggle('is-active', btn === button));
          setCityVisible(city);
          if (city !== 'all') {
            scrollToTarget(button.dataset.cityTarget);
          }
        });
      });
    }

    const toRad = (value) => (value * Math.PI) / 180;
    const haversineKm = (lat1, lng1, lat2, lng2) => {
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat / 2) ** 2
        + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
      return 6371 * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    };

    const formatDistance = (km) => {
      if (!Number.isFinite(km)) return '';
      if (km < 1) return `${Math.round(km * 1000)} m`;
      if (km < 10) return `${km.toFixed(1)} km`;
      return `${Math.round(km)} km`;
    };

    let cachedLocation = null;
    let locationPromise = null;
    let distanceReady = false;

    const getLocation = () => {
      if (cachedLocation) return Promise.resolve(cachedLocation);
      if (locationPromise) return locationPromise;
      locationPromise = new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('GEO_NOT_SUPPORTED'));
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            cachedLocation = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
            };
            distanceReady = true;
            resolve(cachedLocation);
          },
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 300000 }
        );
      });
      return locationPromise;
    };

    const cacheDefaultOrder = (section) => {
      section.querySelectorAll('.company-grid').forEach((grid) => {
        Array.from(grid.children).forEach((card, index) => {
          if (!card.dataset.order) {
            card.dataset.order = String(index);
          }
        });
      });
    };

    const setDistances = (section, location) => {
      const cards = Array.from(section.querySelectorAll('.company-card[data-lat][data-lng]'));
      cards.forEach((card) => {
        const lat = Number.parseFloat(card.dataset.lat);
        const lng = Number.parseFloat(card.dataset.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
        const km = haversineKm(location.lat, location.lng, lat, lng);
        card.dataset.distance = String(km);
        const distanceEl = card.querySelector('[data-distance]');
        if (distanceEl) {
          distanceEl.textContent = `距你 ${formatDistance(km)}`;
          distanceEl.hidden = false;
        }
      });
    };

    const sortByDistance = (section) => {
      section.querySelectorAll('.company-grid').forEach((grid) => {
        const cards = Array.from(grid.children);
        cards.sort((a, b) => {
          const da = Number.parseFloat(a.dataset.distance);
          const db = Number.parseFloat(b.dataset.distance);
          const hasA = Number.isFinite(da);
          const hasB = Number.isFinite(db);
          if (hasA && hasB) return da - db;
          if (hasA) return -1;
          if (hasB) return 1;
          return 0;
        });
        cards.forEach((card) => grid.appendChild(card));
      });
    };

    const restoreDefaultOrder = (section) => {
      section.querySelectorAll('.company-grid').forEach((grid) => {
        const cards = Array.from(grid.children);
        cards.sort((a, b) => {
          const oa = Number.parseInt(a.dataset.order || '0', 10);
          const ob = Number.parseInt(b.dataset.order || '0', 10);
          return oa - ob;
        });
        cards.forEach((card) => grid.appendChild(card));
      });
      if (!distanceReady) {
        section.querySelectorAll('[data-distance]').forEach((el) => {
          el.hidden = true;
        });
      }
    };

    const applyFilter = (section, filter) => {
      const tools = section.querySelector('[data-city-tools]');
      const foodIndustry = tools?.dataset.foodIndustry || '';
      const blocks = Array.from(section.querySelectorAll('.industry-block'));

      if (!filter || filter.value === 'all') {
        blocks.forEach((block) => {
          block.hidden = false;
          block.querySelectorAll('.industry-subgroup').forEach((group) => {
            group.hidden = false;
          });
        });
        return;
      }

      if (filter.scope === 'category') {
        blocks.forEach((block) => {
          if (block.dataset.industry !== foodIndustry) {
            block.hidden = true;
            return;
          }
          block.hidden = false;
          block.querySelectorAll('.industry-subgroup').forEach((group) => {
            group.hidden = group.dataset.category !== filter.value;
          });
        });
        return;
      }

      if (filter.scope === 'industry') {
        blocks.forEach((block) => {
          block.hidden = block.dataset.industry !== filter.value;
          block.querySelectorAll('.industry-subgroup').forEach((group) => {
            group.hidden = false;
          });
        });
      }
    };

    citySections.forEach((section) => {
      cacheDefaultOrder(section);

      const tools = section.querySelector('[data-city-tools]');
      if (!tools) return;

      const sortButtons = Array.from(tools.querySelectorAll('[data-sort]'));
      const filterButtons = Array.from(tools.querySelectorAll('[data-filter]'));

      sortButtons.forEach((button) => {
        button.addEventListener('click', async () => {
          const sortType = button.dataset.sort || 'default';
          sortButtons.forEach((btn) => btn.classList.toggle('is-active', btn === button));

          if (sortType === 'default') {
            restoreDefaultOrder(section);
            return;
          }

          try {
            const location = await getLocation();
            setDistances(section, location);
            sortByDistance(section);
          } catch (err) {
            console.warn('Failed to get location:', err.message || err);
            const fallback = sortButtons.find((btn) => btn.dataset.sort === 'default');
            if (fallback) {
              sortButtons.forEach((btn) => btn.classList.toggle('is-active', btn === fallback));
            }
            restoreDefaultOrder(section);
          }
        });
      });

      filterButtons.forEach((button) => {
        button.addEventListener('click', () => {
          filterButtons.forEach((btn) => btn.classList.toggle('is-active', btn === button));
          applyFilter(section, {
            value: button.dataset.filter || 'all',
            scope: button.dataset.filterScope || 'all',
          });
        });
      });
    });

    setCityVisible('all');

    getLocation()
      .then((location) => {
        citySections.forEach((section) => setDistances(section, location));
      })
      .catch((err) => {
        console.warn('Failed to preload location:', err.message || err);
      });
  })();
</script>
